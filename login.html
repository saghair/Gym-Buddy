<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gym Buddy – Login</title>
  <link rel="stylesheet" href="assets/css/style.css" />
</head>
<body>
<header>
  <div class="navbar">
    <a href="index.html" class="brand">
      <div class="brand-pill">GB</div>
      <span>Gym Buddy</span>
    </a>
    <nav>
      <ul>
        <li><a href="login.html" class="active">Login</a></li>
      </ul>
    </nav>
  </div>
</header>

<main>
  <h1 class="page-title">Welcome to Gym Buddy</h1>
  <p class="page-subtitle">
    Log in or create an account to track your workouts and see your progress.
  </p>

  <section class="card">
    <div class="card-header">
      <h2 class="card-title">Sign in / Sign up</h2>
      <span class="badge">Supabase Auth</span>
    </div>

    <div class="card-body">
      <!-- IMPORTANT: no <form> tag to avoid refresh issues -->
      <div class="form-row">
        <div class="field" style="flex: 1;">
          <label for="email">Email</label>
          <input id="email" type="email" autocomplete="email" placeholder="you@example.com" />
        </div>

        <div class="field" style="flex: 1;">
          <label for="password">Password</label>
          <input id="password" type="password" autocomplete="current-password" placeholder="••••••••" />
          <div style="margin-top: 8px; display:flex; gap:10px; align-items:center;">
            <input id="togglePass" type="checkbox" />
            <label for="togglePass" style="margin:0; cursor:pointer;">Show password</label>
          </div>
        </div>
      </div>

      <div class="btn-row" style="margin-top: 14px;">
        <button id="btn-login" type="button" class="btn btn-primary">Log in</button>
        <button id="btn-signup" type="button" class="btn btn-outline">Sign up</button>
      </div>

      <div id="auth-status" class="status-text" style="margin-top: 12px;"></div>

      <div style="margin-top: 12px; opacity: 0.8; font-size: 0.95rem;">
        <div><strong>Status:</strong> <span id="debug-status">Checking…</span></div>
        <div style="margin-top:6px;">
          <button id="btn-logout" type="button" class="btn btn-outline" style="display:none;">Log out</button>
          <button id="btn-go-dashboard" type="button" class="btn btn-primary" style="display:none;">Go to dashboard</button>
        </div>
      </div>
    </div>
  </section>
</main>

<script type="module">
  // Show errors on the page (no silent failures)
  const statusEl = document.getElementById("auth-status");
  const debugEl = document.getElementById("debug-status");

  window.addEventListener("error", (e) => {
    statusEl.textContent = "JS error: " + (e.message || "Check console");
  });
  window.addEventListener("unhandledrejection", (e) => {
    statusEl.textContent = "Promise error: " + (e.reason?.message || "Check console");
  });

  // DOM elements
  const emailEl = document.getElementById("email");
  const passEl = document.getElementById("password");
  const btnLogin = document.getElementById("btn-login");
  const btnSignup = document.getElementById("btn-signup");
  const togglePass = document.getElementById("togglePass");
  const btnLogout = document.getElementById("btn-logout");
  const btnGoDashboard = document.getElementById("btn-go-dashboard");

  togglePass.addEventListener("change", () => {
    passEl.type = togglePass.checked ? "text" : "password";
  });

  // Import Supabase client
  let supabase, getCurrentUser;

  try {
    ({ supabase, getCurrentUser } = await import("./assets/js/supabaseClient.js"));
  } catch (err) {
    statusEl.textContent =
      "Could not load Supabase client. Check that /assets/js/supabaseClient.js exists and is deployed.";
    debugEl.textContent = "Supabase client NOT loaded ❌";
    console.error(err);
    throw err;
  }

  debugEl.textContent = "Supabase client loaded ✅";

  function setBusy(isBusy) {
    btnLogin.disabled = isBusy;
    btnSignup.disabled = isBusy;
    btnLogout.disabled = isBusy;
    btnGoDashboard.disabled = isBusy;
  }

  function show(msg, isError = false) {
    statusEl.textContent = msg;
    statusEl.style.opacity = "1";
  }

  // Check session on load
  async function refreshSessionUI() {
    const user = await getCurrentUser();
    if (user) {
      debugEl.textContent = "Signed in as " + user.email + " ✅";
      btnLogout.style.display = "inline-block";
      btnGoDashboard.style.display = "inline-block";
    } else {
      debugEl.textContent = "Not signed in";
      btnLogout.style.display = "none";
      btnGoDashboard.style.display = "none";
    }
  }

  await refreshSessionUI();

  btnGoDashboard.addEventListener("click", () => {
    window.location.href = "index.html";
  });

  btnLogout.addEventListener("click", async () => {
    setBusy(true);
    show("Logging out…");
    await supabase.auth.signOut();
    show("Logged out.");
    setBusy(false);
    await refreshSessionUI();
  });

  // Login
  btnLogin.addEventListener("click", async () => {
    const email = (emailEl.value || "").trim();
    const password = passEl.value || "";

    if (!email || !password) {
      show("Please enter email and password.", true);
      return;
    }

    setBusy(true);
    show("Signing in…");

    const { error } = await supabase.auth.signInWithPassword({ email, password });

    if (error) {
      show("Login failed: " + error.message, true);
      setBusy(false);
      return;
    }

    show("Logged in! Redirecting…");
    await refreshSessionUI();
    setBusy(false);

    // small delay so user sees message
    setTimeout(() => (window.location.href = "index.html"), 300);
  });

  // Signup
  btnSignup.addEventListener("click", async () => {
    const email = (emailEl.value || "").trim();
    const password = passEl.value || "";

    if (!email || !password) {
      show("Please enter email and password.", true);
      return;
    }
    if (password.length < 6) {
      show("Password must be at least 6 characters.", true);
      return;
    }

    setBusy(true);
    show("Creating account…");

    const { error } = await supabase.auth.signUp({ email, password });

    if (error) {
      show("Sign up failed: " + error.message, true);
      setBusy(false);
      return;
    }

    show("Account created. If email confirmation is enabled, check your inbox.");
    setBusy(false);
    await refreshSessionUI();
  });
</script>
</body>
</html>
