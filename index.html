<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Gym Buddy – AI Workout</title>
  <link rel="stylesheet" href="assets/css/style.css" />
  <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>
</head>
<body>
<header>
  <div class="navbar">
    <a href="index.html" class="brand">
      <div class="brand-pill">GB</div>
      <span>Gym Buddy</span>
    </a>
    <nav>
      <ul>
        <li><a href="index.html" class="active">Home</a></li>
        <li><a href="saved-workouts.html">Saved</a></li>
        <li><a href="profile.html">Profile</a></li>
        <li><a href="#" id="logout">Logout</a></li>
      </ul>
    </nav>
  </div>
</header>

<main>
  <h1 class="page-title">AI Smart Workout</h1>
  <p class="page-subtitle">Generated automatically for you</p>

  <article class="card">
    <div class="card-header">
      <h2 class="card-title">Today’s Plan</h2>
      <span class="badge">AI</span>
    </div>

    <div class="card-body">
      <div id="loading" style="display:none; text-align:center;">
        <lottie-player
          src="https://assets10.lottiefiles.com/packages/lf20_usmfx6bp.json"
          style="width:160px;height:160px;margin:auto"
          loop autoplay>
        </lottie-player>
        <div class="status-text">Generating workout…</div>
      </div>

      <div class="btn-row">
        <button id="refresh" class="btn btn-outline">Refresh</button>
        <button id="save" class="btn btn-primary" disabled>Save Workout</button>
      </div>

      <div id="cards" class="grid" style="margin-top:1rem;"></div>
      <div id="status" class="status-text"></div>
    </div>
  </article>
</main>

<script type="module">
import { supabase, getCurrentUser } from "./assets/js/supabaseClient.js";
import { callGymBuddyAI, buildSuggestionsPromptJSON } from "./assets/js/ai.js";

const loading = document.getElementById("loading");
const cards = document.getElementById("cards");
const refreshBtn = document.getElementById("refresh");
const saveBtn = document.getElementById("save");
const status = document.getElementById("status");

let user;
let latestWorkout;

(async () => {
  user = await getCurrentUser();
  if (!user) location.href = "login.html";
  await loadWorkout();
})();

refreshBtn.onclick = loadWorkout;

saveBtn.onclick = async () => {
  saveBtn.disabled = true;
  await supabase.from("ai_workouts").insert({
    user_id: user.id,
    title: latestWorkout.title,
    workout_json: JSON.stringify(latestWorkout)
  });
  status.textContent = "Saved ✔ (check Saved page)";
};

async function loadWorkout() {
  saveBtn.disabled = true;
  status.textContent = "";
  cards.innerHTML = "";
  loading.style.display = "block";

  const { data: profile } = await supabase
    .from("user_profiles")
    .select("*")
    .eq("user_id", user.id)
    .single();

  const prompt = buildSuggestionsPromptJSON({
    goal: profile?.goal,
    weightKg: profile?.weight_kg
  });

  const reply = await callGymBuddyAI(prompt, "suggestions_json");
  latestWorkout = JSON.parse(reply);

  loading.style.display = "none";
  saveBtn.disabled = false;

  renderWorkout(latestWorkout);
}

function renderWorkout(w) {
  addCard(`<strong>${w.todaySummary}</strong><br><br>
    ${w.progressionTip}<br><br>
    ${w.nutritionTip}<br><br>
    ${w.recoveryTip}`, true);

  w.exercises.forEach(ex => {
    const query = encodeURIComponent(ex.videoQuery);
    addCard(`
      <div class="video-frame">
        <iframe
          src="https://www.youtube.com/embed?listType=search&list=${query}&autoplay=0&mute=1"
          loading="lazy">
        </iframe>
      </div>
      <div class="video-hint">Hover / tap to play</div>
      <strong>${ex.name}</strong><br>
      ${ex.sets} sets · ${ex.reps} · rest ${ex.rest}
    `);
  });
}

function addCard(html, full = false) {
  const el = document.createElement("article");
  el.className = "card fade-in";
  if (full) el.style.gridColumn = "1 / -1";
  el.innerHTML = `<div class="card-body">${html}</div>`;
  cards.appendChild(el);
  requestAnimationFrame(() => el.classList.add("show"));
}
</script>
</body>
</html>
