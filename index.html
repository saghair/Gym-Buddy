<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Gym Buddy â€“ Dashboard</title>
  <link rel="stylesheet" href="assets/css/style.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<header>
  <div class="navbar">
    <a href="index.html" class="brand">
      <div class="brand-pill">GB</div>
      <span>Gym Buddy</span>
    </a>
    <nav>
      <ul>
        <li><a href="index.html" class="active">Home</a></li>
        <li><a href="build-workout.html">Build workout</a></li>
        <li><a href="workouts.html">Workouts</a></li>
        <li><a href="programs.html">Programs</a></li>
        <li><a href="challenges.html">Challenges</a></li>
        <li><a href="tools.html">Tools</a></li>
        <li><a href="profile.html">Profile</a></li>
        <li><a href="#" id="logout-link">Logout</a></li>
      </ul>
    </nav>
  </div>
</header>

<main>
  <h1 class="page-title">Your training dashboard</h1>
  <p class="page-subtitle" id="welcome-text">
    Loading your data...
  </p>

  <section class="grid">
    <article class="card">
      <div class="card-header">
        <h2 class="card-title">Log todayâ€™s session</h2>
        <span class="badge">Tracking</span>
      </div>
      <div class="card-body">
        <div class="field">
          <label for="session-weight">
            Total weight lifted today (kg, rough estimate)
          </label>
          <input id="session-weight" type="number" min="0" />
        </div>
        <div class="btn-row">
          <button id="btn-save-session" class="btn btn-primary">
            Save session
          </button>
        </div>
        <div id="log-status" class="status-text"></div>
      </div>
    </article>

    <article class="card">
      <div class="card-header">
        <h2 class="card-title">This week</h2>
        <span class="badge">Stats</span>
      </div>
      <div class="card-body">
        <p id="sessions-this-week">Sessions this week: â€“</p>
        <p id="trend-text">Trend: â€“</p>
      </div>
    </article>
  </section>

  <section class="grid" style="margin-top: 1.5rem;">
    <article class="card">
      <div class="card-header">
        <h2 class="card-title">Weight lifted over time</h2>
        <span class="badge">Progress</span>
      </div>
      <div class="card-body">
        <canvas id="weightChart" height="160"></canvas>
      </div>
    </article>

    <article class="card">
      <div class="card-header">
        <h2 class="card-title">Sessions per day (last 7 days)</h2>
        <span class="badge">Consistency</span>
      </div>
      <div class="card-body">
        <canvas id="sessionsChart" height="160"></canvas>
      </div>
    </article>
  </section>
</main>

<script type="module">
  import { supabase, getCurrentUser } from "./assets/js/supabaseClient.js";

  const welcomeText = document.getElementById("welcome-text");
  const logoutLink = document.getElementById("logout-link");
  const btnSave = document.getElementById("btn-save-session");
  const weightInput = document.getElementById("session-weight");
  const logStatus = document.getElementById("log-status");
  const sessionsThisWeekEl = document.getElementById("sessions-this-week");
  const trendTextEl = document.getElementById("trend-text");

  let currentUser = null;
  let weightChart = null;
  let sessionsChart = null;

  (async () => {
    currentUser = await getCurrentUser();
    if (!currentUser) {
      window.location.href = "login.html";
      return;
    }
    welcomeText.textContent = `Welcome back, ${currentUser.email}`;
    await loadCharts();
  })();

  logoutLink.addEventListener("click", async (e) => {
    e.preventDefault();
    await supabase.auth.signOut();
    window.location.href = "login.html";
  });

  btnSave.addEventListener("click", async () => {
    const w = parseFloat(weightInput.value);
    if (Number.isNaN(w) || w <= 0) {
      logStatus.textContent = "Please enter a valid weight.";
      return;
    }
    logStatus.textContent = "Saving...";
    const today = new Date().toISOString().slice(0, 10);

    const { error } = await supabase
      .from("workout_sessions")
      .insert({
        user_id: currentUser.id,
        session_date: today,
        total_weight: w
      });

    if (error) {
      console.error(error);
      logStatus.textContent = "Error saving session.";
    } else {
      logStatus.textContent = "Session saved!";
      weightInput.value = "";
      await loadCharts();
    }
  });

  async function loadCharts() {
    const { data, error } = await supabase
      .from("workout_sessions")
      .select("*")
      .eq("user_id", currentUser.id)
      .order("session_date", { ascending: true });

    if (error) {
      console.error(error);
      return;
    }

    const labels = data.map((row) => row.session_date);
    const weights = data.map((row) => Number(row.total_weight || 0));

    const ctx1 = document.getElementById("weightChart").getContext("2d");
    if (weightChart) weightChart.destroy();
    weightChart = new Chart(ctx1, {
      type: "line",
      data: {
        labels,
        datasets: [
          {
            label: "Total weight (kg)",
            data: weights
          }
        ]
      },
      options: {
        scales: {
          y: { beginAtZero: true }
        }
      }
    });

    const now = new Date();
    const last7 = [];
    for (let i = 6; i >= 0; i--) {
      const d = new Date(now);
      d.setDate(d.getDate() - i);
      last7.push(d.toISOString().slice(0, 10));
    }

    const counts = last7.map((day) =>
      data.filter((row) => row.session_date === day).length
    );

    const ctx2 = document.getElementById("sessionsChart").getContext("2d");
    if (sessionsChart) sessionsChart.destroy();
    sessionsChart = new Chart(ctx2, {
      type: "bar",
      data: {
        labels: last7,
        datasets: [
          {
            label: "Sessions",
            data: counts
          }
        ]
      },
      options: {
        scales: {
          y: { beginAtZero: true, ticks: { stepSize: 1 } }
        }
      }
    });

    const sessionsThisWeek = counts.reduce((a, b) => a + b, 0);
    sessionsThisWeekEl.textContent = `Sessions this week: ${sessionsThisWeek}`;

    if (weights.length >= 6) {
      const last3 = weights.slice(-3).reduce((a, b) => a + b, 0) / 3;
      const prev3 = weights.slice(-6, -3).reduce((a, b) => a + b, 0) / 3;
      if (last3 > prev3 + 1) {
        trendTextEl.textContent = "Trend: going up ðŸ”¼";
      } else if (last3 < prev3 - 1) {
        trendTextEl.textContent = "Trend: going down ðŸ”½";
      } else {
        trendTextEl.textContent = "Trend: stable âž–";
      }
    } else {
      trendTextEl.textContent = "Trend: not enough data yet.";
    }
  }
</script>
</body>
</html>
